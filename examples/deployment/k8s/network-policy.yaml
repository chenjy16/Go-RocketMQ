# Go-RocketMQ 网络策略配置

---
# 默认拒绝所有入站流量的网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: security
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
# NameServer网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nameserver-network-policy
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: nameserver
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: nameserver
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 允许来自Broker的连接
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
      ports:
        - protocol: TCP
          port: 9876
    
    # 允许来自客户端的连接
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: go-rocketmq
        - namespaceSelector:
            matchLabels:
              name: default
      ports:
        - protocol: TCP
          port: 9876
    
    # 允许监控系统访问metrics端口
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8080
    
    # 允许健康检查
    - from: []
      ports:
        - protocol: TCP
          port: 8080
  
  egress:
    # 允许DNS解析
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # 允许访问Kubernetes API
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    
    # 允许与其他NameServer通信
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: nameserver
      ports:
        - protocol: TCP
          port: 9876

---
# Broker Master网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: broker-master-network-policy
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: broker
    broker-role: master
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: broker
      broker-role: master
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 允许来自客户端的连接
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: go-rocketmq
        - namespaceSelector:
            matchLabels:
              name: default
      ports:
        - protocol: TCP
          port: 10911
    
    # 允许来自Broker Slave的HA连接
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
              broker-role: slave
      ports:
        - protocol: TCP
          port: 10912
    
    # 允许监控系统访问metrics端口
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8080
    
    # 允许健康检查
    - from: []
      ports:
        - protocol: TCP
          port: 8080
  
  egress:
    # 允许DNS解析
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # 允许访问NameServer
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: nameserver
      ports:
        - protocol: TCP
          port: 9876
    
    # 允许访问Kubernetes API
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    
    # 允许与Broker Slave通信
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
              broker-role: slave
      ports:
        - protocol: TCP
          port: 10921
        - protocol: TCP
          port: 10922

---
# Broker Slave网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: broker-slave-network-policy
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: broker
    broker-role: slave
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: broker
      broker-role: slave
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 允许来自客户端的连接（只读）
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: go-rocketmq
        - namespaceSelector:
            matchLabels:
              name: default
      ports:
        - protocol: TCP
          port: 10921
    
    # 允许来自Broker Master的HA连接
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
              broker-role: master
      ports:
        - protocol: TCP
          port: 10922
    
    # 允许监控系统访问metrics端口
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8080
    
    # 允许健康检查
    - from: []
      ports:
        - protocol: TCP
          port: 8080
  
  egress:
    # 允许DNS解析
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # 允许访问NameServer
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: nameserver
      ports:
        - protocol: TCP
          port: 9876
    
    # 允许访问Broker Master进行HA同步
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
              broker-role: master
      ports:
        - protocol: TCP
          port: 10912
    
    # 允许访问Kubernetes API
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443

---
# 客户端网络策略（生产者和消费者）
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: client-network-policy
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: client
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: client
  policyTypes:
    - Egress
  egress:
    # 允许DNS解析
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # 允许访问NameServer
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: nameserver
      ports:
        - protocol: TCP
          port: 9876
    
    # 允许访问Broker Master
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
              broker-role: master
      ports:
        - protocol: TCP
          port: 10911
    
    # 允许访问Broker Slave（消费者可能需要）
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: broker
              broker-role: slave
      ports:
        - protocol: TCP
          port: 10921
    
    # 允许访问外部服务（如果需要）
    - to: []
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443

---
# 监控系统网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-network-policy
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: monitoring
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 允许来自Grafana的访问
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
        - podSelector:
            matchLabels:
              app: grafana
      ports:
        - protocol: TCP
          port: 9090  # Prometheus
        - protocol: TCP
          port: 9093  # Alertmanager
    
    # 允许外部访问（通过Ingress）
    - from: []
      ports:
        - protocol: TCP
          port: 3000  # Grafana
  
  egress:
    # 允许DNS解析
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # 允许访问RocketMQ组件的metrics端口
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: go-rocketmq
      ports:
        - protocol: TCP
          port: 8080
    
    # 允许访问Kubernetes API
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    
    # 允许发送告警通知
    - to: []
      ports:
        - protocol: TCP
          port: 25   # SMTP
        - protocol: TCP
          port: 587  # SMTP TLS
        - protocol: TCP
          port: 465  # SMTP SSL
        - protocol: TCP
          port: 80   # Webhook
        - protocol: TCP
          port: 443  # Webhook HTTPS

---
# 跨命名空间访问策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cross-namespace-access
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: go-rocketmq
  policyTypes:
    - Ingress
  ingress:
    # 允许来自指定命名空间的访问
    - from:
        - namespaceSelector:
            matchLabels:
              rocketmq-access: "true"
      ports:
        - protocol: TCP
          port: 9876  # NameServer
        - protocol: TCP
          port: 10911 # Broker Master
        - protocol: TCP
          port: 10921 # Broker Slave
    
    # 允许来自系统命名空间的访问
    - from:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8080  # Metrics

---
# Ingress网络策略（如果使用Ingress暴露服务）
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ingress-network-policy
  namespace: rocketmq
  labels:
    app.kubernetes.io/name: go-rocketmq
    app.kubernetes.io/part-of: go-rocketmq
    app.kubernetes.io/component: ingress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: ingress
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 允许来自Ingress Controller的流量
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
  
  egress:
    # 允许访问后端RocketMQ服务
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: go-rocketmq
      ports:
        - protocol: TCP
          port: 9876
        - protocol: TCP
          port: 10911
        - protocol: TCP
          port: 10921
        - protocol: TCP
          port: 8080